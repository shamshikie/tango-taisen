<h1 align="center">対戦型英単語学習アプリ Wordify 仕様書</h1>

概要
----
<strong>英単語学習をリアルタイムのオンライン対戦形式で行うことで、英単語学習のやる気アップをサポートするアプリケーション</strong>

- オンライン対戦モードは最大4人が参加でき、ランクマッチとルームマッチの2種類が存在し、前者はランダムな相手と自分のランクポイントを賭けた対戦、後者は気軽に任意のプレイヤーと遊べる対戦である。
- オンライン対戦だけでなく、一人用モードやフレンド機能などの機能がある。

利用者
-----
- 日本人の英語学習者
- 小学校高学年以上 (英語学習が始まる年齢)
- 友達やライバルと競い合いながら英単語学習をしたい人

目的
----
- 背景
  - 現代の教育環境において、英語の重要性が増している
  - 義務教育や高校で学習する英単語数が増加
  - 多すぎる単語数に嫌気が差している人も多いと推測

<p>オンライン対戦、フレンド機能によってゲーム感覚で学習を行い、英語学習のやる気向上につなげてもらう</p>


ユースケース
----
- 電車通学・通勤中の空き時間で学習
- 学校のテスト前、TOEICや英検の試験に向け、自宅、学校などで英単語の復習
- 外出先でのちょっとした時間潰しに
    -  交通機関や病院、飲食店などの待ち時間など

機能・仕様
-----
※ * がついているものは想定はしているが実際には実装していないものを示す
- **認証**
  - ASP.NET Core 個人認証 によるログイン
    - メールアドレス & パスワード
  - ロール*
    - 管理者*
        - 不適切、不正なユーザーの利用停止など
    - 一般ユーザー
        - 学習機能の利用
        - 学習データの記録
        - 全国ランキングの閲覧
        - マイページの閲覧
        - フレンド機能の利用
        - 通知の受信

### 一般ユーザーのアカウントに関して
ASP.NET Core 個人認証用テーブルとアプリ専用のAppUserテーブルを使用
- 新規登録に必要なもの
    - メールアドレス
        - AspNetUser & AppUserテーブル兼用
    - パスワード
        - AspNetUser用
        - 6~100文字
        - アルファベット (大文字) & アルファベット (小文字) & 数字 & 記号すべて最低1つ含む
    - ユーザーネーム
        - AppUser用
        - AppUserテーブル内でユニーク
        - 1~15文字
        - 小文字と大文字を区別しない
        - 英数字とアンダースコア (_) のみ使用可能
        - **変更不可**
    - ニックネーム
        - AppUserのIdを外部キーとして持つProfileテーブル用
        - 1~10文字
- ログインに必要なもの
    - メールアドレス
    - パスワード

### 一般ユーザー向け機能
- 4択クイズ
    - 4択の採用理由
      - モバイルとPC端末の入力デバイスによる差を小さくするため
      - 綴り入力はデバイスの入力インターフェースの慣れによって差が大きく出てしまうため
  - 英語 (問題) →日本語 (選択肢)
  - 英単語の音声再生*
  - クイズが遊べるゲームモード
    - 1人用モード
      - トレーニングモード
    - リアルタイム対戦モード
      - ランクマッチ
      - ルームマッチ
- トレーニングモード (1人用モード)
    - 以下の3つの単語設定から1つを選択
      - Category (カテゴリー)
        - 学年 (小中高大、大学入試)
        - 資格 (TOEIC、英検など)
        - 場面 (ITなど)
      - Level (Weblio基準)
        - Lv.1 ~ Lv.20
      - Weakness (苦手な単語の復習)
        - 正答率が低いものを優先して出題
    - 問題数選択
        - 1~50問
- ランクマッチ
  - ランク制
    - ユーザーはランクポイントを所持
      - 最低0ポイント
    - ある一定のランクポイントで昇格/降格
      - ランク表参照
    - ランクが上がるにつれ、単語レベルも上昇*
  - 4人の**ランダム対戦**
    - 対戦ページに遷移すると待機部屋に入室
      - 規定の人数 (4人)が集まると対戦部屋に移り対戦開始
    - 対戦結果の順位で自身のランクポイントが増加/減少
      - ランクポイントの変動はオンライン対戦のフローを参照
    - ランクポイントが近いもの同士でマッチング*
    - 問題数や人数はサーバー側で事前に設定
        - デフォルトの問題数: 5
    - 結果発表
      - 順位 & ランクポイントの変動
  - 対戦履歴
    - 日付、順位の確認
      - 対戦ユーザーのプロフィール閲覧
    - 友達申請*
- ルームマッチ (リアルタイム対戦)
  - 最大4人
    - 1人でもプレイ可能
  - 部屋の作成
    - 作成者はホストとなる
      - ホストはゲームを開始できる
      - ホストが抜けた場合、部屋にいる他の人がホストとなる
    - ルームIDの発行
      - GUIDを採用 (2^128通り)
    - 問題数選択
        - 1~10問
    - 単語の問題設定*
  - 部屋への入室方法
    - ルームIDの入力
      - 前後スペースのトリム
      - 大文字→小文字変換
    - アプリ内通知によるフレンド招待の受信
  - プレイヤーの招待
    - 自分のフレンド一覧から招待
      - オンラインのユーザーが上位に表示
      - 招待されたユーザーは通知を受信
      - フレンド一覧のキーワードフィルター
        - 部分一致検索
          - 前後スペースのトリム
          - 大文字→小文字変換
          - 全角半角変換などの機能は未実装
    - SNS, emailを用いた招待
      - ルームのURLを共有
  - 友達申請*
  - ルーム内のコミュニケーション*
    - スタンプの送受信
      - 例）はじめます、ばいばい、あと一回など
    - チャット不可
      - 小学生の利用も想定しているため
      - チャット・通話は、外部サービス (Line, Discord)の使用を想定
- 全国ランキング
  - リーダーボード
    - 上位30名のランクポイント、プロフィールを閲覧
    - 自身の順位の確認
  - 日替わりのランキング*
    - お題が提示される
      - 例. 一日で解いた問題数、TOEIC問題の正解数など
    - 昨日限定のランキング結果を表示
    - リーダーボードは常に上位者しかこないため、誰でもランキング入りできるようにするためのランキング
- フレンド機能 
  - フレンド一覧
    - 閲覧できる項目
      - 名前、アイコン、ランクポイント
      - オンラインかオフライン状態か
      - フレンド成立日
      - プロフィールページへの遷移
    - 削除
    - ブロック*
  - フレンドリクエスト申請
    - ユーザーネームの完全一致 (大文字小文字の区別なし)
    - 対戦履歴から*
    - ルームマッチ中の追加*
  - フレンドリクエストの受信
    - フレンドリクエスト件数の表示
    - 承認or拒否の選択
    - フレンドリクエスト送信者のプロフィール閲覧
- マイページ
  - 自分のプロフィール表示
    - ニックネーム
    - 自己紹介 (Bio)
      - 最大160文字
      - SNSのIDなどを書くことは禁止
        - 運営のパトロールが必要
        - 通報機能*
    - アイコン
      - アプリ内で事前に用意 
        - 現在7種類
    - アプリ登録日
    - ユーザーネーム (自分のみ閲覧可能)
    - 最近のアクティビティ表示*
      - 例) 連続ログインやランキング上位にはいったことなど
    - プロフィール編集ボタン
  - プロフィール編集
    - ニックネーム、アイコン、Bioの変更
    - プロフィールの公開設定
      - オフにすると他人からはアイコンとニックネームのみが表示
      - フレンドのみ公開する設定*
- My単語帳
  - アプリ内の単語一覧を表示
  - フィルター機能
    - 既出単語、未回答単語、すべて
      - 検索
        - アルファベットは前方一致
        - 日本語は部分一致
          - 「〔…に〕服従するなど」の意味があるため
  - ソート*
    - デフォルトは最近解いた単語が上位に表示される
  - 各単語の情報表示
    - レベル
    - 単語ごとの正解率
    - 品詞
    - 複数の意味の表示
      - 意味ごとの正解数、出題数
  - ページネーション
    - 最初と最後のページと現在のページの前後2ページが表示
- ログアウト
- アカウント設定
  - メールアドレス変更
  - パスワード変更
  - 2要素認証
  - アカウントの削除
- アプリ内通知
  - 新規通知件数表示
  - 受信日時の表示
  - 通知の種類
    - フレンドリクエストの受信
      - 通知画面から承諾、拒否が可能
        - 返信後は承諾拒否ボタンが非表示
    - フレンドからの部屋招待
      - 入室ボタン
        - 既に解散していた場合ボタンは非表示
    - 運営からのお知らせ*
      - 特定のリンク先に遷移
    - 称号獲得*
  - **半年経過したものはDBから自動削除する運用**
- ブラウザ通知*
  - 特定の時間にリマインダー
    - 例) 毎日学習の設定
- 報酬システム*
  - 称号
    - ある特定の条件をクリアすると獲得
      - 例）100単語連続正解、1週間毎日学習 
- 共通ページ
  - ホーム画面 (非ログインユーザー限定) 
    - アプリのデモ画面スライドショー
    - 新規登録
    - ログイン
    - ログインユーザーがアクセスした場合、Rank/Indexに遷移
  - 遊び方
    - 概要、プレイガイド、ランク表、FAQ
  - プライバシーポリシー
  - 問い合わせ*
  - 非ログイン状態の場合、右上にログイン、新規登録が表示
  - ログイン状態の場合、右上には通知アイコン、プロフィールアイコンが表示

### ページの種類
- Home
  - Index 
    - 非ログイン者限定
    - ログイン状態の場合Rank/Indexに遷移
  - HowTo
    - Outline, PlayGuide, Rank, FAQタブ
  - Privacy
  - Support
#### ここからログイン者限定
- Training
  - Index 
    - Weakness, Category, LevelモーダルのフォームからPlayに遷移
  - Play
- Ranking
  - Index
    - Leaderboard, DailyRankingモーダル
- Rank
  - Index
    - Match Historyモーダル
  - Play
- Friends
  - Index
    - フレンドリクエストモーダル
    - フレンドリクエストボタンからFriendRequests/Indexに遷移
- FriendRequests
  - Index
- Room
  - Index
    - Create, JoinモーダルからJoinに遷移
  - Join
- Profile
  - Index
    - 自分のプロフィールページ
    - 編集ボタンからEditに遷移
  - {id}
    - 他人のプロフィールページ
  - Edit
- MyWords
  - Index  
- Identity
  - Account
    - Manage
      - 省略
    - Login
    - Register

### ルームマッチのページ遷移詳細仕様
- 既に削除(解散)されている、または存在しないルームIDをクエリ文字列にしてURL移動
  - 例. /Rooms/Join?roomId=8b77d174-cc08-4516-bca3-7f4e8964cb07
  - アラートが表示され、Room/Indexに遷移
- 待機中にページを複製
  - 新しいタブが優先され、古いタブは無効となる
- 待機中にリロード
  - 一回退室して再度入室扱い
    - ホストだった場合は他の人がホストとなる
  - 1人または複数人が同時リロード場合、通信状況によっては部屋が削除され、アラート表示後にRoom/Indexに遷移
- 待機中にページを閉じる
  - 部屋から削除され、部屋内の他のプレイヤー画面にもそれが反映される
- クイズ中にページを複製
  - 新しいページが優先され、古いタブは無効となる
- クイズ中にリロード
  - クイズ結果がでるまでに完了すれば、復帰可能
  - 結果が出ていた場合、退室し再入室扱い (再現は難しい)
- クイズ中にページを閉じる
  - すぐには部屋から削除されず、部屋に残る
  - 結果発表までに同じページに戻ると再開できる
  - 結果発表後になると部屋から削除され、復帰すると再入室扱い
  - 全員が閉じた場合、部屋が削除され復帰不可

### ランクマッチのページ遷移詳細仕様
- 待機中にページを複製
  - 新しいページが優先され、古いページは無効となる
- 待機中にリロード
  - 一回退室して再度入室扱い
    - 他の待機プレイヤーからは待機人数が一瞬減り、すぐに戻ったように見える
- 待機中にページを閉じる
  - 待機部屋から削除され、部屋内の他のプレイヤー画面にもそれが反映される
- クイズ中にページを複製
  - 新しいページが優先され、古いページは無効となる
- クイズ中にリロード
  - クイズ結果がでるまでに完了すれば、復帰可能
  - リロード中に結果が出ていた場合、リザルトは表示されず待機部屋に移る(再現は難しい)
- クイズ中にページを閉じる
  - 対戦部屋から削除されず、対戦部屋に残る
  - 結果発表までに同じページに戻ると再開できる
  - 結果発表後に同じページ飛ぶと待機部屋に移る
    - DBには登録される
  - 全員が閉じた場合、部屋が削除され復帰不可
    - DBにも登録されない

### ランク表

|ランク|ポイント範囲|学校目安|Level*|
|-|-|-|-|
|A+|1100~|大学以上||
|A |1000~1099|大学以上||
|A-|900~999|大学以上||
|B+|800~899|高校||
|B |700~799|高校||
|B-|600~699|高校||
|C+|500~599|中学校||
|C |400~499|中学校||
|C-|300~399|中学校||
|D+|200~299|小学校||
|D |100~199|小学校||
|D-|0~99|小学校||

#### 問題点
  - ランクごとに出題する単語レベルを変える
    - 単語ごとのLevel登録がほとんどできていない
      - Weblioのスクレイピング禁止があとになって発覚
    - Weblioによると中学生レベルあたりまではレベル1

### オンライン対戦のフロー
1. 問題と選択肢 (4択) が表示
2. 4秒タイマー開始 (1と同時)
3. プレイヤーはタイマーが切れていなければ選択肢から回答
4. タイマーが終了
5. 正解発表
6. 得点の配分
    - 早く正解したプレイヤーほど高得点 
        - 回答順位 (1st, 2nd, 3rd, 4th) = 獲得ポイント (20, 10, 5, 2) 
        - 同着がいたときのポイント獲得例
          - (20, 20, 5, 2)
          - (20, 10, 10, 2)
          - (20, 10, 10, 10)
          - めったに起こらないと思われる
    - **無回答の場合±0pt**
    - 不正解の場合はマイナス 
      - (1st, 2nd, 3rd, 4th) = (-20, -10, -5, -2)
      - 例. (正解,不正解,正解,不正解) → (20, -10, 5, -2)
    - プレイヤーの合計ポイントは0が最小値 (負数なし)
7. 既定の問題数まで進行
8. 最終得点に基づいてプレイヤーの順位を発表
9. ランクマッチの場合、対戦の順位に応じて、ランクポイントが増減
    - 順位 (1st, 2nd, 3rd, 4th) = 獲得できるランクポイント (20, 10, -10, -20)

DB設計
----
**[docs/ERdiagram.pdf.md](LearningWordsOnline/README.md) に記載**

使用環境
----
- サーバー
  - OS
    - Windows
- クライアント
  - OS
    - Windows
    - 未検証
      - Linux, MacOS, iOS, Android
  - 想定デバイス
    - PC、スマートフォン、タブレット
  - ブラウザ
    - Microsoft Edge, Google Chrome 

収益構造
----
### 運営者収益
  - アプリ内広告* 
    - どの場所に表示されるか、考える必要あり
    - 一定時間アプリ全面広告
  - サブスク登録*
    - 登録者は広告非表示

オンライン対戦用のクイズ機能の設計
---

### バックエンド側の処理
1. クライアントから問題要求を受信
    - 既に送った問題の場合、無視
    - 前回の問題を回答を送信していないのに新しい問題の要求が来た場合、無視
1. 問題を全クライアントに一斉送信
1. 回答と回答残り時間をクライアントから受信
    - 回答残り時間 = 4秒 - 回答にかかった時間
    - 回答がなかったクライアントは未回答扱い
    - 同じクライアントから重複した回答がきた場合、無視
1. クライアントから正解要求を受信
    - 既に送っていた場合、無視
1. 全クライアントに正解を一斉送信
1. クライアントから届いた回答と回答時間を元に各回答者が獲得できるポイントを計算＆送信
    - 獲得ポイントはオンライン対戦のフローを参照
    - 送信するのは獲得ポイントではなく、部屋内の全プレイヤーの増減後の合計ポイント
1. 既定の問題数、上記を繰り返し
1. 順位結果を送信
1. 各プレイヤーに変動後のランクポイントと変動したポイントを送信

このようにサーバー側では待機処理を使っていない
 
### フロントエンド側の処理
1. 問題を要求
1. 問題をサーバーから取得
1. タイマー1 (4秒) & タイマー2 (8秒) 開始 
1. タイマー1が切れるまで回答の送信が可能
    - 未回答の場合は空文字を送信
1. タイマー1終了
1. タイマー2が終了したら、正解を要求
1. サーバーから正解を取得
1. サーバーから部屋内の全プレイヤーの合計ポイントを取得
1. 既定の問題数、上記を繰り返し
1. 順位結果を受信
1. 変動後のランクポイントと変動したポイントを受信

※トレーニングモードでは、サーバーがクライアントに一度にすべての問題＆正答を送信し、クライアントが全問回答した時点で、クライアントはサーバーにすべての回答を送信する。